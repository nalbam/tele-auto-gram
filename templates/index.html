<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="web-token" content="{{ web_token }}">
    <title>TeleAutoGram</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f7;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* === Sidebar === */
        .sidebar {
            width: 320px;
            background: linear-gradient(180deg, #5b21b6 0%, #7c3aed 100%);
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            left: 0; top: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar-header { padding: 30px 25px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .logo-icon { font-size: 32px; }
        .logo-text { font-size: 20px; font-weight: 700; }
        .subtitle { font-size: 13px; opacity: 0.85; margin-left: 44px; }

        .nav-menu { padding: 20px 15px; flex: 1; overflow-y: auto; }
        .nav-button {
            width: 100%; padding: 14px 18px; background: transparent; color: white;
            border: none; border-radius: 10px; font-size: 15px; font-weight: 600;
            cursor: pointer; transition: all 0.2s; text-align: left;
            display: flex; align-items: center; gap: 12px; margin-bottom: 8px;
        }
        .nav-button:hover { background: rgba(255,255,255,0.15); transform: translateX(4px); }
        .nav-button.active { background: rgba(255,255,255,0.2); }
        .nav-icon { font-size: 18px; width: 20px; text-align: center; }

        /* Sidebar conversations */
        .sidebar-conv-list { margin-top: 20px; }
        .sidebar-conv-header {
            font-size: 12px; font-weight: 600; opacity: 0.7;
            padding: 10px 18px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .sidebar-conv-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 15px; margin: 2px 0; border-radius: 10px;
            cursor: pointer; transition: all 0.2s;
        }
        .sidebar-conv-item:hover { background: rgba(255,255,255,0.1); }
        .sidebar-conv-item.active { background: rgba(255,255,255,0.2); }
        .sidebar-conv-avatar {
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 700; font-size: 14px; flex-shrink: 0;
        }
        .sidebar-conv-info { flex: 1; min-width: 0; }
        .sidebar-conv-name { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
        .sidebar-conv-preview {
            font-size: 12px; opacity: 0.7;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .sidebar-footer { padding: 20px 25px; border-top: 1px solid rgba(255,255,255,0.1); }
        .status-indicator { display: flex; align-items: center; gap: 10px; font-size: 13px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; animation: pulse 2s infinite; }
        .status-dot.configured { background: #10b981; }
        .status-dot.not-configured { background: #f59e0b; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* === Main Content === */
        .main-content {
            margin-left: 320px; flex: 1;
            display: flex; flex-direction: column; height: 100vh;
        }
        .top-bar {
            background: white; padding: 20px 40px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-bottom: 1px solid #e5e7eb; flex-shrink: 0;
        }
        .page-title { font-size: 24px; font-weight: 700; color: #1f2937; }
        .content-area {
            padding: 30px 40px; flex: 1; overflow-y: auto; min-height: 0;
        }
        .content-area.chat-mode {
            padding: 0; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* Chat top bar header */
        .chat-top-bar { display: none; align-items: center; gap: 14px; }
        .chat-top-bar.active { display: flex; }
        .chat-back-btn {
            background: none; border: none; cursor: pointer; padding: 4px;
            color: #6b7280; display: flex; align-items: center; transition: color 0.2s;
        }
        .chat-back-btn:hover { color: #1f2937; }
        .chat-top-avatar {
            width: 38px; height: 38px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 700; font-size: 15px; flex-shrink: 0;
        }
        .chat-top-name { font-size: 18px; font-weight: 700; color: #1f2937; }

        /* === Alert === */
        .alert {
            padding: 16px 20px; border-radius: 12px; margin-bottom: 24px;
            display: none; font-weight: 500; border: 1px solid;
        }
        .alert.success { background: #d1fae5; color: #065f46; border-color: #6ee7b7; }
        .alert.error { background: #fee2e2; color: #991b1b; border-color: #fca5a5; }
        .alert.show { display: block; }

        /* === Card (auth/settings) === */
        .card {
            background: white; border-radius: 16px; padding: 32px;
            margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
        }
        .card-header {
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #f3f4f6;
        }
        .card-icon { font-size: 24px; }
        .card-title { font-size: 20px; font-weight: 700; color: #1f2937; }

        /* === Form === */
        .form-group { margin-bottom: 24px; }
        .form-group label {
            display: block; margin-bottom: 8px; color: #374151;
            font-weight: 600; font-size: 14px;
        }
        .form-group input, .form-group textarea {
            width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb;
            border-radius: 10px; font-size: 15px; transition: all 0.2s; font-family: inherit;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none; border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124,58,237,0.1);
        }
        .form-group small { display: block; margin-top: 6px; color: #6b7280; font-size: 13px; }

        /* === Button === */
        .btn {
            background: linear-gradient(135deg, #5b21b6 0%, #7c3aed 100%);
            color: white; border: none; padding: 14px 32px; border-radius: 10px;
            font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(124,58,237,0.3); }
        .btn:active { transform: translateY(0); }

        /* === Conversation List Cards === */
        .conv-card {
            display: flex; align-items: center; gap: 16px;
            padding: 18px 24px; background: white; border-radius: 14px;
            cursor: pointer; transition: all 0.2s; border: 1px solid #e5e7eb;
            margin-bottom: 8px;
        }
        .conv-card:hover {
            background: #faf5ff; border-color: #c4b5fd;
            transform: translateY(-1px); box-shadow: 0 4px 12px rgba(124,58,237,0.1);
        }
        .conv-avatar {
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 700; font-size: 20px; flex-shrink: 0;
        }
        .conv-info { flex: 1; min-width: 0; }
        .conv-top-row {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;
        }
        .conv-name { font-weight: 700; font-size: 15px; color: #1f2937; }
        .conv-time { font-size: 12px; color: #9ca3af; flex-shrink: 0; }
        .conv-preview {
            font-size: 14px; color: #6b7280;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .conv-meta { text-align: right; flex-shrink: 0; }
        .conv-msg-count {
            display: inline-flex; align-items: center; justify-content: center;
            background: #7c3aed; color: white; font-size: 11px; font-weight: 700;
            min-width: 20px; height: 20px; padding: 0 6px; border-radius: 10px; margin-top: 4px;
        }

        /* === Chat Room === */
        #view-chat.active { display: flex; flex: 1; min-height: 0; }
        .chat-container {
            display: flex; flex-direction: column; flex: 1; min-height: 0; overflow: hidden;
        }
        .chat-messages {
            flex: 1; overflow-y: auto; padding: 10px 16px;
            display: flex; flex-direction: column; gap: 1px; background: #f8f9fb;
        }
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .chat-date-divider { text-align: center; margin: 10px 0 6px; }
        .chat-date-divider span {
            background: #e5e7eb; color: #6b7280;
            padding: 2px 10px; border-radius: 10px; font-size: 11px; font-weight: 500;
        }
        .chat-bubble-row { display: flex; margin: 1px 0; }
        .chat-bubble-row.received { justify-content: flex-start; }
        .chat-bubble-row.sent { justify-content: flex-end; }
        .chat-bubble {
            max-width: 70%; padding: 8px 12px; border-radius: 14px;
            font-size: 13px; line-height: 1.4; word-wrap: break-word; white-space: pre-wrap;
        }
        .chat-bubble.received {
            background: white; color: #1f2937;
            border: 1px solid #e5e7eb; border-bottom-left-radius: 4px;
        }
        .chat-bubble.sent {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            color: white; border-bottom-right-radius: 4px;
        }
        .chat-bubble-time { font-size: 10px; margin-top: 2px; opacity: 0.6; }
        .chat-bubble.sent .chat-bubble-time { text-align: right; }
        .chat-input-area {
            display: flex; gap: 8px; padding: 8px 16px 10px;
            border-top: 1px solid #e5e7eb; background: white; align-items: flex-end;
        }
        .chat-input-area textarea {
            flex: 1; padding: 8px 14px; border: 2px solid #e5e7eb;
            border-radius: 20px; font-size: 13px; font-family: inherit;
            resize: none; min-height: 38px; max-height: 100px;
            outline: none; transition: border-color 0.2s; line-height: 1.4;
        }
        .chat-input-area textarea:focus {
            border-color: #7c3aed; box-shadow: 0 0 0 3px rgba(124,58,237,0.1);
        }
        .chat-send-btn {
            width: 38px; height: 38px; border-radius: 50%;
            background: linear-gradient(135deg, #5b21b6, #7c3aed);
            color: white; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; flex-shrink: 0;
        }
        .chat-send-btn:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(124,58,237,0.4); }
        .chat-send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }

        /* === Empty state === */
        .empty-state { text-align: center; padding: 60px 20px; color: #9ca3af; }
        .empty-state-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state-text { font-size: 16px; font-weight: 500; }
        .empty-state-sub { font-size: 14px; margin-top: 8px; opacity: 0.7; }

        /* === Status / Auth badges === */
        .status-badge {
            display: inline-block; padding: 8px 16px; border-radius: 8px;
            font-size: 14px; font-weight: 600; margin-bottom: 20px;
        }
        .status-badge.configured { background: #d1fae5; color: #065f46; }
        .status-badge.not-configured { background: #fef3c7; color: #92400e; }
        .auth-status-badge {
            display: inline-block; padding: 8px 16px; border-radius: 8px;
            font-size: 14px; font-weight: 600; margin-bottom: 20px;
        }
        .auth-status-badge.authorized { background: #d1fae5; color: #065f46; }
        .auth-status-badge.waiting_code, .auth-status-badge.waiting_password { background: #fef3c7; color: #92400e; }
        .auth-status-badge.disconnected { background: #f3f4f6; color: #6b7280; }
        .auth-status-badge.error { background: #fee2e2; color: #991b1b; }
        .auth-error {
            background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5;
            padding: 12px 16px; border-radius: 10px; margin-bottom: 20px; font-weight: 500;
        }
        .auth-success { text-align: center; padding: 40px 20px; color: #065f46; }
        .auth-success-icon { font-size: 48px; margin-bottom: 12px; }
        .auth-success-text { font-size: 18px; font-weight: 600; }

        /* === View Toggle === */
        .view-container { display: none; }
        .view-container.active { display: block; }

        /* === Responsive === */
        @media (max-width: 768px) {
            .sidebar {
                width: 280px; transform: translateX(-100%);
                transition: transform 0.3s; z-index: 100;
            }
            .sidebar.mobile-open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .top-bar { padding: 16px 20px; }
            .content-area { padding: 20px; }
            .content-area.chat-mode { padding: 0; }
            .card { padding: 20px; }
            .chat-bubble { max-width: 80%; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <span class="logo-icon">üì±</span>
                <span class="logo-text">TeleAutoGram</span>
            </div>
            <div class="subtitle">Auto Response System</div>
        </div>
        <div class="nav-menu">
            <button class="nav-button active" onclick="switchView('conversations')" id="nav-conversations">
                <span class="nav-icon">üí¨</span><span>Conversations</span>
            </button>
            <button class="nav-button" onclick="switchView('auth')" id="nav-auth">
                <span class="nav-icon">üîê</span><span>Auth</span>
            </button>
            <button class="nav-button" onclick="switchView('settings')" id="nav-settings">
                <span class="nav-icon">‚öôÔ∏è</span><span>Settings</span>
            </button>
            <div class="sidebar-conv-list" id="sidebar-conv-list"></div>
        </div>
        <div class="sidebar-footer">
            <div class="status-indicator">
                <div class="status-dot not-configured" id="sidebar-status-dot"></div>
                <span id="sidebar-status-text">Not Configured</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="top-bar" id="top-bar">
            <h1 class="page-title" id="page-title">Conversations</h1>
            <div class="chat-top-bar" id="chat-top-bar">
                <button class="chat-back-btn" onclick="exitChatRoom()">
                    <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                </button>
                <div class="chat-top-avatar" id="chat-top-avatar"></div>
                <span class="chat-top-name" id="chat-top-name"></span>
            </div>
        </div>

        <div class="content-area" id="content-area">
            <div id="alert" class="alert"></div>

            <!-- Conversation List View -->
            <div class="view-container active" id="view-conversations">
                <div id="conv-list-container"></div>
            </div>

            <!-- Chat Room View -->
            <div class="view-container" id="view-chat">
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input-area" id="chat-input-area">
                        <textarea id="chat-input" placeholder="Type a message..." rows="1"></textarea>
                        <button class="chat-send-btn" id="chat-send-btn" onclick="sendMessage()">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Auth View -->
            <div class="view-container" id="view-auth">
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üîê</span>
                        <h2 class="card-title">Telegram Auth</h2>
                    </div>
                    <div id="auth-status-container"></div>
                    <div id="auth-error-container"></div>
                    <div id="auth-form-container"></div>
                </div>
            </div>

            <!-- Settings View -->
            <div class="view-container" id="view-settings">
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">‚öôÔ∏è</span>
                        <h2 class="card-title">Bot Settings</h2>
                    </div>
                    <div id="status-container"></div>
                    <form id="config-form">
                        <div class="form-group">
                            <label for="api_id">API ID</label>
                            <input type="text" id="api_id" name="api_id" required>
                            <small>Telegram API ID (from my.telegram.org)</small>
                        </div>
                        <div class="form-group">
                            <label for="api_hash">API Hash</label>
                            <input type="text" id="api_hash" name="api_hash" required>
                            <small>Telegram API Hash (from my.telegram.org)</small>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone Number</label>
                            <input type="text" id="phone" name="phone" required>
                            <small>Include country code (e.g. +821012345678)</small>
                        </div>
                        <div class="form-group">
                            <label for="auto_response_message">Auto Response Message (Fallback)</label>
                            <textarea id="auto_response_message" name="auto_response_message" rows="4"></textarea>
                            <small>Default response used when AI is not configured or fails</small>
                        </div>
                        <div class="form-group">
                            <label>Response Delay (seconds)</label>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <input type="number" id="response_delay_min" name="response_delay_min" min="0" step="1" style="width: 100px;" placeholder="3">
                                <span style="color: #6b7280;">~</span>
                                <input type="number" id="response_delay_max" name="response_delay_max" min="0" step="1" style="width: 100px;" placeholder="10">
                            </div>
                            <small>Random delay before auto-response (min ~ max seconds, default: 3 ~ 10)</small>
                        </div>
                        <div class="card-header" style="margin-top: 16px;">
                            <span class="card-icon">ü§ñ</span>
                            <h2 class="card-title">AI Response Settings</h2>
                        </div>
                        <div class="form-group">
                            <label for="openai_api_key">OpenAI API Key</label>
                            <input type="text" id="openai_api_key" name="openai_api_key">
                            <small>OpenAI API key (enables AI-powered auto responses)</small>
                        </div>
                        <div class="form-group">
                            <label for="openai_model">OpenAI Model</label>
                            <input type="text" id="openai_model" name="openai_model" placeholder="gpt-4o-mini">
                            <small>OpenAI model to use (default: gpt-4o-mini)</small>
                        </div>
                        <div class="form-group">
                            <label for="identity_content">Identity (data/IDENTITY.md)</label>
                            <textarea id="identity_content" rows="10" placeholder="e.g. I am a developer in my 30s. I talk in a friendly, casual tone." style="font-family: monospace; font-size: 13px;"></textarea>
                            <small>Persona and style guide for AI responses ‚Äî Markdown format (saved as data/IDENTITY.md)</small>
                            <button type="button" class="btn" style="margin-top: 10px; padding: 10px 20px; font-size: 13px;" onclick="saveIdentity()"><span>üíæ</span><span>Save Identity</span></button>
                        </div>
                        <button type="submit" class="btn"><span>üíæ</span><span>Save Settings</span></button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === Auth Token ===
        const WEB_TOKEN = document.querySelector('meta[name="web-token"]')?.content || '';
        function authFetch(url, options = {}) {
            if (WEB_TOKEN) {
                options.headers = Object.assign({}, options.headers, {
                    'Authorization': 'Bearer ' + WEB_TOKEN
                });
            }
            return fetch(url, options);
        }

        // === State ===
        let allMessages = [];
        let conversations = [];
        let selectedConversation = null;

        // === Utilities ===
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }
        function getInitial(name) { return name ? name.charAt(0).toUpperCase() : '?'; }
        function getAvatarColor(name) {
            const colors = ['#7c3aed','#2563eb','#059669','#d97706','#dc2626','#0891b2','#7c2d12','#4f46e5'];
            let h = 0;
            for (let i = 0; i < (name||'').length; i++) h = name.charCodeAt(i) + ((h << 5) - h);
            return colors[Math.abs(h) % colors.length];
        }
        function truncate(t, n) { return t.length > n ? t.substring(0, n) + '...' : t; }
        function formatMsgTime(ts) {
            return new Date(ts).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }
        function formatConvTime(ts) {
            const d = new Date(ts), now = new Date();
            const diff = Math.floor((now - d) / 86400000);
            if (diff === 0) return formatMsgTime(ts);
            if (diff === 1) return 'Yesterday';
            if (diff < 7) return d.toLocaleDateString('en-US', { weekday: 'short' });
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        function formatDateDivider(ts) {
            return new Date(ts).toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
            });
        }
        function showAlert(message, type) {
            const el = document.getElementById('alert');
            el.textContent = message;
            el.className = `alert ${type} show`;
            setTimeout(() => el.classList.remove('show'), 5000);
        }

        // === View Management ===
        function switchView(viewName) {
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            const contentArea = document.getElementById('content-area');
            const pageTitle = document.getElementById('page-title');
            const chatTopBar = document.getElementById('chat-top-bar');

            if (viewName === 'conversations') {
                document.getElementById('nav-conversations').classList.add('active');
                pageTitle.style.display = '';
                pageTitle.textContent = 'Conversations';
                chatTopBar.classList.remove('active');
                contentArea.classList.remove('chat-mode');
                selectedConversation = null;
                renderConversationList();
                updateSidebar();
            } else if (viewName === 'chat') {
                document.getElementById('nav-conversations').classList.add('active');
                pageTitle.style.display = 'none';
                chatTopBar.classList.add('active');
                contentArea.classList.add('chat-mode');
                if (selectedConversation) {
                    const n = selectedConversation.sender_name;
                    document.getElementById('chat-top-name').textContent = n;
                    const av = document.getElementById('chat-top-avatar');
                    av.textContent = getInitial(n);
                    av.style.background = getAvatarColor(n);
                }
            } else if (viewName === 'auth') {
                document.getElementById('nav-auth').classList.add('active');
                pageTitle.style.display = '';
                pageTitle.textContent = 'Auth';
                chatTopBar.classList.remove('active');
                contentArea.classList.remove('chat-mode');
                _lastAuthStatus = null;
                _lastAuthError = null;
                loadAuthStatus();
            } else if (viewName === 'settings') {
                document.getElementById('nav-settings').classList.add('active');
                pageTitle.style.display = '';
                pageTitle.textContent = 'Settings';
                chatTopBar.classList.remove('active');
                contentArea.classList.remove('chat-mode');
            }

            document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + viewName).classList.add('active');
        }

        // === Config ===
        async function loadConfig() {
            try {
                const response = await authFetch('/api/config');
                const data = await response.json();
                if (data.API_ID) document.getElementById('api_id').value = data.API_ID;
                if (data.API_HASH) document.getElementById('api_hash').value = data.API_HASH;
                if (data.PHONE) document.getElementById('phone').value = data.PHONE;
                if (data.AUTO_RESPONSE_MESSAGE) document.getElementById('auto_response_message').value = data.AUTO_RESPONSE_MESSAGE;
                if (data.OPENAI_API_KEY) document.getElementById('openai_api_key').value = data.OPENAI_API_KEY;
                if (data.OPENAI_MODEL) document.getElementById('openai_model').value = data.OPENAI_MODEL;
                document.getElementById('response_delay_min').value = data.RESPONSE_DELAY_MIN ?? 3;
                document.getElementById('response_delay_max').value = data.RESPONSE_DELAY_MAX ?? 10;
                loadIdentity();
                updateStatus(data.is_configured);
            } catch (error) {
                showAlert('Failed to load settings', 'error');
            }
        }
        function updateStatus(isConfigured) {
            const sc = document.getElementById('status-container');
            const sd = document.getElementById('sidebar-status-dot');
            const st = document.getElementById('sidebar-status-text');
            if (isConfigured) {
                sc.innerHTML = '<div class="status-badge configured">‚úì Configured</div>';
                sd.className = 'status-dot configured'; st.textContent = 'Configured';
            } else {
                sc.innerHTML = '<div class="status-badge not-configured">‚ö† Not Configured</div>';
                sd.className = 'status-dot not-configured'; st.textContent = 'Not Configured';
            }
        }
        document.getElementById('config-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const cfg = {
                API_ID: fd.get('api_id'), API_HASH: fd.get('api_hash'), PHONE: fd.get('phone'),
                AUTO_RESPONSE_MESSAGE: fd.get('auto_response_message'),
                OPENAI_API_KEY: fd.get('openai_api_key'),
                OPENAI_MODEL: fd.get('openai_model') || 'gpt-4o-mini',
                RESPONSE_DELAY_MIN: parseInt(fd.get('response_delay_min')) || 3,
                RESPONSE_DELAY_MAX: parseInt(fd.get('response_delay_max')) || 10
            };
            try {
                const r = await authFetch('/api/config', {
                    method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(cfg)
                });
                if (r.ok) { showAlert('Settings saved', 'success'); loadConfig(); }
                else { showAlert('Failed to save settings', 'error'); }
            } catch (err) { showAlert('Error saving settings', 'error'); }
        });

        // === Identity ===
        async function loadIdentity() {
            try {
                const r = await authFetch('/api/identity');
                const data = await r.json();
                document.getElementById('identity_content').value = data.content || '';
            } catch (err) { console.error('Error loading identity:', err); }
        }
        async function saveIdentity() {
            const content = document.getElementById('identity_content').value;
            try {
                const r = await authFetch('/api/identity', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ content })
                });
                if (r.ok) showAlert('Identity saved', 'success');
                else showAlert('Failed to save identity', 'error');
            } catch (err) { showAlert('Error saving identity', 'error'); }
        }

        // === Messages & Conversations ===
        async function loadMessages() {
            try {
                const r = await authFetch('/api/messages');
                allMessages = await r.json();
                conversations = buildConversations(allMessages);
                updateSidebar();

                const chatActive = document.getElementById('view-chat').classList.contains('active');
                const convActive = document.getElementById('view-conversations').classList.contains('active');
                if (chatActive && selectedConversation) renderChatMessages();
                else if (convActive) renderConversationList();
            } catch (err) { console.error('Error loading messages:', err); }
        }

        function buildConversations(messages) {
            const map = new Map();
            for (const msg of messages) {
                const sid = msg.sender_id;
                if (!sid) {
                    if (msg.direction === 'received') {
                        const key = 'name:' + msg.sender;
                        if (!map.has(key)) map.set(key, { sender_id: null, sender_name: msg.sender, messages: [] });
                        map.get(key).messages.push(msg);
                    }
                    continue;
                }
                const key = 'id:' + sid;
                if (!map.has(key)) map.set(key, { sender_id: sid, sender_name: null, messages: [] });
                const conv = map.get(key);
                conv.messages.push(msg);
                if (msg.direction === 'received' && msg.sender !== 'Me') conv.sender_name = msg.sender;
            }
            return Array.from(map.values())
                .filter(c => c.sender_name)
                .sort((a, b) => {
                    const at = a.messages[a.messages.length - 1].timestamp;
                    const bt = b.messages[b.messages.length - 1].timestamp;
                    return bt.localeCompare(at);
                });
        }

        function renderConversationList() {
            const container = document.getElementById('conv-list-container');
            if (conversations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí¨</div>
                        <div class="empty-state-text">No conversations yet</div>
                        <div class="empty-state-sub">Messages will appear here when received</div>
                    </div>`;
                return;
            }
            container.innerHTML = conversations.map(conv => {
                const last = conv.messages[conv.messages.length - 1];
                const preview = last.direction === 'sent' ? 'Me: ' + last.text : last.text;
                const time = formatConvTime(last.timestamp);
                const initial = getInitial(conv.sender_name);
                const color = getAvatarColor(conv.sender_name);
                const received = conv.messages.filter(m => m.direction === 'received').length;
                return `
                    <div class="conv-card" data-sender-id="${conv.sender_id || ''}" data-sender-name="${escapeHtml(conv.sender_name)}">
                        <div class="conv-avatar" style="background:${color}">${initial}</div>
                        <div class="conv-info">
                            <div class="conv-top-row">
                                <span class="conv-name">${escapeHtml(conv.sender_name)}</span>
                                <span class="conv-time">${time}</span>
                            </div>
                            <div class="conv-preview">${escapeHtml(truncate(preview, 40))}</div>
                        </div>
                        <div class="conv-meta">
                            <div class="conv-msg-count">${received}</div>
                        </div>
                    </div>`;
            }).join('');
            container.querySelectorAll('.conv-card[data-sender-id]').forEach(el => {
                el.addEventListener('click', () => {
                    const sid = el.dataset.senderId;
                    if (sid) enterChatRoom(Number(sid), el.dataset.senderName);
                });
            });
        }

        // === Chat Room ===
        function enterChatRoom(senderId, senderName) {
            if (!senderId) return;
            selectedConversation = { sender_id: senderId, sender_name: senderName };
            switchView('chat');
            renderChatMessages();
            updateSidebar();
            document.getElementById('chat-input').focus();
        }

        function exitChatRoom() {
            selectedConversation = null;
            document.getElementById('chat-input').value = '';
            switchView('conversations');
        }

        function renderChatMessages() {
            if (!selectedConversation) return;
            const conv = conversations.find(c => c.sender_id === selectedConversation.sender_id);
            const container = document.getElementById('chat-messages');

            if (!conv || conv.messages.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-text">No messages</div></div>';
                return;
            }

            const wasAtBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 50;
            let html = '';
            let lastDate = null;

            for (const msg of conv.messages) {
                const msgDate = new Date(msg.timestamp).toDateString();
                if (msgDate !== lastDate) {
                    html += `<div class="chat-date-divider"><span>${formatDateDivider(msg.timestamp)}</span></div>`;
                    lastDate = msgDate;
                }
                const dir = msg.direction;
                const time = formatMsgTime(msg.timestamp);
                html += `<div class="chat-bubble-row ${dir}"><div class="chat-bubble ${dir}"><div>${escapeHtml(msg.text)}</div><div class="chat-bubble-time">${time}</div></div></div>`;
            }

            container.innerHTML = html;
            if (wasAtBottom || !container.dataset.init) {
                container.scrollTop = container.scrollHeight;
                container.dataset.init = '1';
            }

            const inputArea = document.getElementById('chat-input-area');
            inputArea.style.display = selectedConversation.sender_id ? 'flex' : 'none';
        }

        async function sendMessage() {
            if (!selectedConversation || !selectedConversation.sender_id) return;
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            const btn = document.getElementById('chat-send-btn');
            btn.disabled = true;
            try {
                const r = await authFetch('/api/messages/send', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ user_id: selectedConversation.sender_id, text })
                });
                if (r.ok) {
                    input.value = '';
                    input.style.height = 'auto';
                    await loadMessages();
                } else {
                    const data = await r.json();
                    showAlert(data.message || 'Failed to send message', 'error');
                }
            } catch (err) { showAlert('Error sending message', 'error'); }
            finally { btn.disabled = false; }
        }

        // === Sidebar ===
        function updateSidebar() {
            const container = document.getElementById('sidebar-conv-list');
            if (conversations.length === 0) { container.innerHTML = ''; return; }
            const selId = selectedConversation ? selectedConversation.sender_id : null;

            container.innerHTML = `
                <div class="sidebar-conv-header">Conversations</div>
                ${conversations.slice(0, 8).map(conv => {
                    const active = selId === conv.sender_id;
                    const last = conv.messages[conv.messages.length - 1];
                    const preview = truncate(last.text, 25);
                    const initial = getInitial(conv.sender_name);
                    const color = getAvatarColor(conv.sender_name);
                    return `
                        <div class="sidebar-conv-item${active ? ' active' : ''}"
                             data-sender-id="${conv.sender_id || ''}" data-sender-name="${escapeHtml(conv.sender_name)}">
                            <div class="sidebar-conv-avatar" style="background:${color}">${initial}</div>
                            <div class="sidebar-conv-info">
                                <div class="sidebar-conv-name">${escapeHtml(conv.sender_name)}</div>
                                <div class="sidebar-conv-preview">${escapeHtml(preview)}</div>
                            </div>
                        </div>`;
                }).join('')}`;
            container.querySelectorAll('.sidebar-conv-item[data-sender-id]').forEach(el => {
                el.addEventListener('click', () => {
                    const sid = el.dataset.senderId;
                    if (sid) enterChatRoom(Number(sid), el.dataset.senderName);
                });
            });
        }

        // === Auth ===
        const AUTH_STATUS_LABELS = {
            'disconnected': 'Disconnected', 'waiting_code': 'Waiting for code',
            'waiting_password': 'Waiting for 2FA password', 'authorized': 'Authorized', 'error': 'Error'
        };
        let _lastAuthStatus = null, _lastAuthError = null;

        async function loadAuthStatus() {
            try {
                const r = await authFetch('/api/auth/status');
                const data = await r.json();
                if (data.status === _lastAuthStatus && data.error === _lastAuthError) return;
                _lastAuthStatus = data.status; _lastAuthError = data.error;
                renderAuthView(data);
            } catch (err) { console.error('Error loading auth status:', err); }
        }
        function renderAuthView(data) {
            const sc = document.getElementById('auth-status-container');
            const ec = document.getElementById('auth-error-container');
            const fc = document.getElementById('auth-form-container');
            sc.innerHTML = `<div class="auth-status-badge ${data.status}">${AUTH_STATUS_LABELS[data.status] || data.status}</div>`;
            ec.innerHTML = data.error ? `<div class="auth-error">${escapeHtml(data.error)}</div>` : '';
            if (data.status === 'waiting_code') {
                fc.innerHTML = `<p style="margin-bottom:16px;color:#374151;">Enter the verification code sent to your Telegram.</p>
                    <form id="auth-code-form"><div class="form-group"><label for="auth_code">Verification Code</label>
                    <input type="text" id="auth_code" placeholder="12345" required autocomplete="one-time-code" inputmode="numeric" maxlength="10">
                    </div><button type="submit" class="btn"><span>üîë</span><span>Submit Code</span></button></form>`;
                document.getElementById('auth-code-form').addEventListener('submit', submitCode);
            } else if (data.status === 'waiting_password') {
                fc.innerHTML = `<p style="margin-bottom:16px;color:#374151;">Enter your two-factor authentication (2FA) password.</p>
                    <form id="auth-password-form"><div class="form-group"><label for="auth_password">2FA Password</label>
                    <input type="password" id="auth_password" required></div>
                    <button type="submit" class="btn"><span>üîë</span><span>Submit Password</span></button></form>`;
                document.getElementById('auth-password-form').addEventListener('submit', submitPassword);
            } else if (data.status === 'authorized') {
                fc.innerHTML = '<div class="auth-success"><div class="auth-success-icon">‚úÖ</div><div class="auth-success-text">Telegram authentication complete</div></div>';
            } else if (data.status === 'disconnected') {
                fc.innerHTML = '<p style="color:#6b7280;">Bot has not started yet. Complete the settings and restart the server.</p>';
            } else if (data.status === 'error') {
                fc.innerHTML = '<p style="color:#991b1b;">An error occurred during authentication. Check your settings and restart the server.</p>';
            } else { fc.innerHTML = ''; }
        }
        async function submitCode(e) {
            e.preventDefault();
            const code = document.getElementById('auth_code').value.trim();
            if (!code) return;
            try {
                const r = await authFetch('/api/auth/code', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({code}) });
                if (r.ok) { showAlert('Verification code submitted','success'); setTimeout(loadAuthStatus,1500); }
                else { const d = await r.json(); showAlert(d.message||'Failed to submit code','error'); }
            } catch(err) { showAlert('Error submitting code','error'); }
        }
        async function submitPassword(e) {
            e.preventDefault();
            const password = document.getElementById('auth_password').value;
            if (!password) return;
            try {
                const r = await authFetch('/api/auth/password', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password}) });
                if (r.ok) { showAlert('Password submitted','success'); setTimeout(loadAuthStatus,1500); }
                else { const d = await r.json(); showAlert(d.message||'Failed to submit password','error'); }
            } catch(err) { showAlert('Error submitting password','error'); }
        }

        // === Input handlers ===
        document.getElementById('chat-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });
        document.getElementById('chat-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && selectedConversation) exitChatRoom();
        });

        // === Init ===
        loadConfig();
        loadMessages();
        setInterval(loadMessages, 10000);
        setInterval(function() {
            const v = document.getElementById('view-auth');
            if (v && v.classList.contains('active')) loadAuthStatus();
        }, 3000);
    </script>
</body>
</html>
